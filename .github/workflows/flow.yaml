name: openlane
on:
  workflow_dispatch:

jobs:
  Instalacion:
    runs-on: ubuntu-latest
    steps:
      - name: Repo principal
        uses: actions/checkout@v3
      - uses: actions/setup-python@v4.7.1
        with:
          python-version: 3.10.5
      - name: Cache OpenLane and PDK
        uses: actions/cache@v2
        id: cache-ol
        with:
          path: |
            /home/runner/.volare
            ${{ github.workspace }}/OL
          key: cache-key-${{ runner.os }}
      - name: Clonar OpenLane
        if: steps.cache-ol.outputs.cache-hit != 'true'
        run: |
          mkdir  ${{ github.workspace }}/OL
          cd ${{ github.workspace }}/OL
          git clone --depth 1 https://github.com/The-OpenROAD-Project/OpenLane.git
      - name: Instalar OpenLane
        if: steps.cache-ol.outputs.cache-hit != 'true'
        run: |
          cd ${{ github.workspace }}/OL/OpenLane
          make
      - name: Correr Test
        if: steps.cache-ol.outputs.cache-hit != 'true'
        run: |
          cd ${{ github.workspace }}/OL/OpenLane
          make test
      - name: Revisar y guardar version OpenLane
        if: steps.cache-ol.outputs.cache-hit != 'true'
        run: |
          docker images
          OPENLANE_TAG=$(docker images --format '{{.Repository}} {{.Tag}}' | awk 'NR==1{print $2}')
          docker save -o ${{ github.workspace }}/OL/cached_image.tar efabless/openlane:${OPENLANE_TAG}
  Run:
    runs-on: ubuntu-latest
    needs: Instalacion
    if: success()
    steps:
      - name: Buscar Archivos de test
        uses: actions/checkout@v3
      - name: Restaurar dependencias
        uses: actions/cache@v2
        with:
          path: |
            /home/runner/.volare
            ${{ github.workspace }}/OL
          key: cache-key-${{ runner.os }}
      - name: Restaurar docker
        run: |
          docker load -i ${{ github.workspace }}/OL/cached_image.tar
      - name: Run Nueva
        uses: addnab/docker-run-action@v3
        with:
          image: efabless/openlane:6ab36bf20edfd4d111b7a59b21f4050622a03f5a
          options: --rm -v ${{ github.workspace }}:${{ github.workspace }} -v ${{ github.workspace }}/OL/OpenLane:/openlane -v ${{ github.workspace }}/OL/OpenLane/empty:/openlane/install -v /home/runner/.volare:/home/runner/.volare -e PDK_ROOT=/home/runner/.volare -e PDK=sky130A
          run: |
            run_synthesis
            run_floorplan
      - name: Subir Resultados
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: Results
          path: |
            ${{ github.workspace }}/OL/OpenLane/designs/src/runs/latest/

